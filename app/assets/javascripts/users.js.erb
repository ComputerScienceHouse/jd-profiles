/*
 * Creates the input field for the given attribute parameters
 * id: the id of the div to add the input field to
 * val: the default value to give it
 */
function create_input(id, val) {
    var attr_id = id.slice(15, id.length);  // ex: cn_0
    var attr = attr_id.split('_')[0];       // ex: cn
    var input_id = "attr_input_" + attr_id; // ex: attr_input_cn_0

    $('#' + id).append('<input id="' + input_id + '" name="' + attr_id + '" type="text" value="' + val  + '">');
    $('#' + input_id).keypress(function(event) {
        if (event.which == 13) {
            event.preventDefault();
            $('#attr_form_' + attr).submit();
        }
    });
}

/*
 * Flashes the success status to the user. It makes the inputs' border color
 * green if it successfully updated, red otherwise
 * id: the id of the inputs to modify
 * success: if the updats was successful
 */
function flash_success(id, success) {
    var org_border_color = $(id).css('border-color');
    var org_border_width = $(id).css('border-width');
    var border_color = success ? 'rgb(35, 230, 35)' : 'red';

    $(id).css('border-color', border_color);
    $(id).css('border-width', '5px');
    
    setTimeout(function() { 
        $(id).css('border-color', org_border_color); 
        $(id).css('border-width', org_border_width); 
    }, 1000);
}

$(document).on('page:change', function () {
        
    $('.attr_form').bind('ajax:success', function(evt, data, xhr) {
        var response = $.parseJSON(status);
        var attr_id = response.key;
        //TODO(batchik): Show error message on failure
        if (response.single == true) {
            if (!response.success) { // reset the value if the attr could not be modified
                $('#attr_input_' + attr_id).val(response.value[0]);
                flash_success('#attr_input_' + attr_id, false);
            } else { // resets the read-only mode's value for the attr
                $('#attr_' + attr_id).text(response.value[0]);
                flash_success('#attr_input_' + attr_id, true);
            }
        } else {
            if (!response.success) {
                $("input[id^='attr_input_" + attr_id + "']").remove();
                $("div[id^='attr_input_div_" + attr_id + "']").each(function(index) {
                    var id = $(this).attr('id'); // ex: attr_input_div_cn_0
                    var val = (index < response.value.length) ? response.value[index] : "";    
                    create_input(id,  val);    
                    });
                flash_success("input[id^='attr_input_" + attr_id + "']", false);
            } else {
                $("div[id^='attr_input_div_" + attr_id + "']").remove();
                var i = 0;
                for (i = 0 ; i < response.value.length ; i++) {
                    var id = "attr_input_div_" + attr_id + "_" + i;
                    $("#attr_form_" + attr_id).append('<div id="' + id + '" class="attr_input_div"></div>');
                    create_input(id,  response.value[i]);

                    // updates the read-only versions and adds new read-only divs if needed
                    if ($("#attr_" + attr_id + "_" + i).length) {
                        $("#attr_" + attr_id + "_" + i).text(response.value[i]);
                    } else {
                        $("#attr_form_" + attr_id).append('<div id="attr_' + attr_id + '_' + i + '" class="attr" style="display: none;"></div>');
                        $("#attr_" + attr_id + "_" + i).text(response.value[i]);
                         
                    }
                }
                // removes any extra values that were just deleted
                while ($("#attr_" + attr_id + "_" + i).length) {
                    $("#attr_" + attr_id + "_" + i).remove(); 
                }
                var id = "attr_input_div_" + attr_id + "_" + response.value.length;
                $("#attr_form_" + attr_id).append('<div id="' + id + '" class="attr_input_div"></div>');
                create_input(id, "");    
                flash_success("input[id^='attr_input_" + attr_id + "']", true);
            } 
        }
    });
    
    var cache = {};
    $("#search_search").autocomplete({
        minLength: 2,
        source: function( request, response ) {
            var term = request.term;
            if ( term in cache ) {
                response( cache[ term ] );
                return;
            }
            $.getJSON( "/autocomplete", request, function( data, status, xhr ) {
                cache[ term ] = data;
                response( data );
            });
        }
    });

    $("#edit_button").click(function(e) {
        if ($(this).text() == "edit") {
            $(this).text("done");
            $('.attr_form').css('display', 'inherit'); // unhides empty fields
            $('.attr').hide();                         // hides all the current info
            $('.attr_input_div').each(function(index) {
                var id = $(this).attr('id');           // ex: attr_input_div_cn_0
                var attr_id = id.slice(15, id.length); // ex: cn_0
                var val = $('#attr_' + attr_id).text();
                create_input(id, val);    
            });
        } else {
            /* hides all empty forms */
            $('.attr_form').each(function(index) {
                var is_empty = true;
                $(this).find('input').each(function(index) {
                    if (index != 0 && $(this).val().length != 0) {
                        is_empty = false;
                        return false;
                    }
                });
                if (is_empty) {
                    $(this).css('display', 'none');
                }
            });
            
            $(this).text("edit");
            $('.attr').show();
            $('.attr_input_div').empty();

            // This forces a reflow to deal with the columns
            $('body').hide();
            setTimeout(function() { $('body').show(); }, 0);
        }
    });


    $('#image_thumb').click(function() {
        if ($("#image_form").css("display") == "none") {
            $("#image_form").css("display", "inherit");    
        } else {
            $("#image_form").css("display", "none");    
        }
    });
});
